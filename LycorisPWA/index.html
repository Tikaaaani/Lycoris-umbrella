<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lycoris Tests</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#922B3E">
</head>
<body>
    <div id="app">
        <!-- –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
        <div id="auth-screen" class="screen active">
            <div class="container">
                <h1>üéØ Lycoris</h1>
                <p>–¢–µ—Å—Ç—ã –∏ –æ–±—É—á–µ–Ω–∏–µ</p>
                
                <div class="auth-form">
                    <input type="email" id="email" placeholder="Email" class="input">
                    <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" class="input">
                    <button onclick="login()" class="btn btn-primary">–í–æ–π—Ç–∏</button>
                    <button onclick="toggleMode()" class="btn btn-secondary">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                </div>
            </div>
        </div>
        
        <!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω (—Å–∫—Ä—ã—Ç —Å–Ω–∞—á–∞–ª–∞) -->
        <div id="main-screen" class="screen">
            <div class="container">
                <h1>–ì–ª–∞–≤–Ω–∞—è</h1>
                <div class="menu">
                    <button onclick="showTests()" class="btn btn-primary">–ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç</button>
                    <button onclick="showStats()" class="btn btn-primary">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
                </div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —Å–ø–∏—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤ -->
        <div id="tests-screen" class="screen">
            <div class="container">
                <h1>üìö –¢–µ—Å—Ç—ã</h1>
                <div id="tests-list" class="tests-container">
                    <!-- –¢–µ—Å—Ç—ã –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
                </div>
                <button onclick="showScreen('main-screen')" class="btn btn-secondary">–ù–∞–∑–∞–¥</button>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–∞ -->
        <div id="test-session-screen" class="screen">
            <div class="container">
                <div id="question-container">
                    <!-- –í–æ–ø—Ä–æ—Å –∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã -->
                </div>
                <div class="test-controls">
                    <button onclick="finishTest()" class="btn-small btn-danger">‚èπÔ∏è</button>
                    <button onclick="previousQuestion()" class="btn-small btn-secondary">‚¨ÖÔ∏è</button>
                    <button onclick="checkAnswer()" class="btn-small btn-warning">‚úÖ</button>
                    <button onclick="nextQuestion()" class="btn-small btn-primary">‚û°Ô∏è</button>
                </div>
                <div id="test-progress"></div>
                <div id="answer-feedback"></div>
            </div>
        </div>
    </div>

    <script>
        // ===== –ë–ê–ó–û–í–ê–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø =====
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }
        
        function login() {
            showScreen('main-screen');
        }
        
        function toggleMode() {
            alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –±—É–¥–µ—Ç –ø–æ–∑–∂–µ');
        }
        
        function showTests() {
            showScreen('tests-screen');
            loadTestsList();
        }
        
        function showStats() {
            alert('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –ø–æ–∑–∂–µ');
        }

        // ===== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –¢–ï–°–¢–û–í =====
        let currentTest = null;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let testStartTime = null;
        let checkedQuestions = new Set();

        // ===== –ó–ê–ì–†–£–ó–ö–ê –°–ü–ò–°–ö–ê –¢–ï–°–¢–û–í =====
        async function loadTestsList() {
            const testsContainer = document.getElementById('tests-list');
            testsContainer.innerHTML = '<p>–ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ—Å—Ç—ã...</p>';

            try {
                const response = await fetch('https://tikaaaani.github.io/Lycoris-umbrella/tests/index.json');
                const data = await response.json();
                
                displayTests(data.tests);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤:', error);
                testsContainer.innerHTML = `
                    <div style="text-align: center; color: #ff4444;">
                        <p>üòî –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ—Å—Ç—ã</p>
                        <p style="font-size: 14px; color: #888;">${error.message}</p>
                        <button onclick="loadTestsList()" class="btn btn-primary" style="margin-top: 15px;">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                    </div>
                `;
            }
        }

        // ===== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –°–ü–ò–°–ö–ê –¢–ï–°–¢–û–í =====
        function displayTests(tests) {
            const testsContainer = document.getElementById('tests-list');
            
            if (tests.length === 0) {
                testsContainer.innerHTML = '<p>–¢–µ—Å—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                return;
            }

            testsContainer.innerHTML = tests.map(test => `
                <div class="test-card" onclick="startTest('${test.id}')">
                    <div class="test-header">
                        <h3>${test.name}</h3>
                        <span class="test-difficulty ${getDifficultyClass(test.difficulty)}">${test.difficulty}</span>
                    </div>
                    <p class="test-description">${test.description}</p>
                    <div class="test-info">
                        <span>üìù ${test.questionCount} –≤–æ–ø—Ä–æ—Å–æ–≤</span>
                        <span>‚è± ${test.estimatedTime}</span>
                        <span class="file-type">${test.fileName.endsWith('.lyc') ? 'üîí' : 'üìÑ'} ${test.fileName.split('.').pop()}</span>
                    </div>
                </div>
            `).join('');
        }

        function getDifficultyClass(difficulty) {
            const difficultyMap = {
                '–õ–µ–≥–∫–∏–π': 'difficulty-easy',
                '–°—Ä–µ–¥–Ω–∏–π': 'difficulty-medium', 
                '–°–ª–æ–∂–Ω—ã–π': 'difficulty-hard',
                'Easy': 'difficulty-easy',
                'Medium': 'difficulty-medium',
                'Hard': 'difficulty-hard'
            };
            return difficultyMap[difficulty] || 'difficulty-medium';
        }

        // ===== –ó–ê–ü–£–°–ö –¢–ï–°–¢–ê =====
        async function startTest(testId) {
            const testsContainer = document.getElementById('tests-list');
            
            try {
                testsContainer.innerHTML = `
                    <div style="text-align: center;">
                        <div class="loading-spinner"></div>
                        <p>–ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ—Å—Ç...</p>
                    </div>
                `;

                const testData = await loadRealTestData(testId);
                
                if (!testData || !testData.questions || testData.questions.length === 0) {
                    throw new Error('–¢–µ—Å—Ç –ø—É—Å—Ç–æ–π –∏–ª–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω');
                }

                currentTest = testData;
                currentQuestionIndex = 0;
                userAnswers = [];
                checkedQuestions = new Set();
                testStartTime = Date.now();
                
                showScreen('test-session-screen');
                displayCurrentQuestion();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–∞:', error);
                testsContainer.innerHTML = `
                    <div class="error-message">
                        <p>‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ—Å—Ç</p>
                        <p style="font-size: 14px; margin-top: 8px;">${error.message}</p>
                        <button onclick="loadTestsList()" class="btn btn-primary" style="margin-top: 15px;">
                            –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É
                        </button>
                    </div>
                `;
            }
        }

        // ===== –†–ï–ê–õ–¨–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê –¢–ï–°–¢–û–í =====
        async function loadRealTestData(testId) {
            try {
                console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ—Å—Ç ID:', testId);
                
                const testsResponse = await fetch('https://tikaaaani.github.io/Lycoris-umbrella/tests/index.json');
                const testsData = await testsResponse.json();
                
                const testInfo = testsData.tests.find(test => test.id === testId);
                if (!testInfo) {
                    throw new Error('–¢–µ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ index.json');
                }

                console.log('–ù–∞–π–¥–µ–Ω —Ç–µ—Å—Ç:', testInfo);

                let testContent;
                
                try {
                    console.log('–ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å JSON:', testInfo.fileName);
                    const jsonResponse = await fetch(`https://tikaaaani.github.io/Lycoris-umbrella/tests/${testInfo.fileName}`);
                    
                    if (!jsonResponse.ok) {
                        throw new Error(`HTTP error! status: ${jsonResponse.status}`);
                    }
                    
                    testContent = await jsonResponse.text();
                    console.log('JSON –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ');
                    
                } catch (jsonError) {
                    console.log('JSON –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–±—É–µ–º LYC...', jsonError);
                    
                    const lycFileName = testInfo.fileName.replace('.json', '.lyc');
                    const lycResponse = await fetch(`https://tikaaaani.github.io/Lycoris-umbrella/tests/${lycFileName}`);
                    
                    if (!lycResponse.ok) {
                        throw new Error(`LYC —Ñ–∞–π–ª —Ç–æ–∂–µ –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω: ${lycResponse.status}`);
                    }
                    
                    const encryptedData = await lycResponse.arrayBuffer();
                    testContent = await decryptTestContent(new Uint8Array(encryptedData));
                    console.log('LYC —Ñ–∞–π–ª —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω');
                }

                const testData = JSON.parse(testContent);
                console.log('–¢–µ—Å—Ç —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω, –≤–æ–ø—Ä–æ—Å–æ–≤:', testData.questions.length);
                
                return {
                    id: testId,
                    title: testInfo.name,
                    questions: testData.questions
                };
                
            } catch (error) {
                console.error('–ü–æ–ª–Ω–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ—Å—Ç–∞:', error);
                throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ—Å—Ç: ' + error.message);
            }
        }

        // ===== –î–ï–®–ò–§–†–û–í–ê–ù–ò–ï .lyc –§–ê–ô–õ–û–í =====
        async function decryptTestContent(encryptedContent) {
            try {
                try {
                    const text = new TextDecoder().decode(encryptedContent);
                    const decoded = atob(text);
                    console.log('–ü—Ä—è–º–æ–µ Base64 –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ');
                    return decoded;
                } catch (simpleError) {
                    console.log('–ü—Ä—è–º–æ–µ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ, –ø—Ä–æ–±—É–µ–º AES...');
                    
                    const key = "YouWillFindYourLoveDear";
                    const keyBytes = normalizeKey(key);
                    
                    const cryptoKey = await crypto.subtle.importKey(
                        'raw',
                        keyBytes,
                        { name: 'AES-CBC' },
                        false,
                        ['decrypt']
                    );

                    const text = new TextDecoder().decode(encryptedContent);
                    const decodedBytes = Uint8Array.from(atob(text), c => c.charCodeAt(0));
                    
                    const iv = decodedBytes.slice(0, 16);
                    const data = decodedBytes.slice(16);
                    
                    const decrypted = await crypto.subtle.decrypt(
                        {
                            name: 'AES-CBC',
                            iv: iv
                        },
                        cryptoKey,
                        data
                    );
                    
                    return new TextDecoder().decode(decrypted);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è:', error);
                throw new Error('–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Ç–µ—Å—Ç–∞: ' + error.message);
            }
        }

        function normalizeKey(key) {
            const keyBytes = new TextEncoder().encode(key);
            const requiredLength = 16;
            
            if (keyBytes.length === requiredLength) {
                return keyBytes;
            }
            
            const normalizedKey = new Uint8Array(requiredLength);
            normalizedKey.set(keyBytes.slice(0, Math.min(keyBytes.length, requiredLength)));
            return normalizedKey;
        }

        // ===== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –í–û–ü–†–û–°–ê –° –¶–í–ï–¢–û–í–û–ô –ü–û–î–°–í–ï–¢–ö–û–ô =====
        function displayCurrentQuestion() {
            const questionContainer = document.getElementById('question-container');
            const progressContainer = document.getElementById('test-progress');
            
            if (!currentTest || !currentTest.questions[currentQuestionIndex]) {
                finishTest();
                return;
            }

            const question = currentTest.questions[currentQuestionIndex];
            const progress = ((currentQuestionIndex + 1) / currentTest.questions.length * 100).toFixed(0);
            const isChecked = checkedQuestions.has(currentQuestionIndex);
            const userAnswer = userAnswers[currentQuestionIndex];
            
            // –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä
            progressContainer.innerHTML = `
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%"></div>
                </div>
                <div class="progress-text">${currentQuestionIndex + 1} / ${currentTest.questions.length}</div>
            `;

            // –í–æ–ø—Ä–æ—Å –∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ —Å —Ü–≤–µ—Ç–æ–≤–æ–π –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π
            questionContainer.innerHTML = `
                <div class="question-card">
                    <h2>${question.question}</h2>
                    <div class="answers-list">
                        ${question.answers.map((answer, index) => {
                            let answerClass = "answer-option";
                            let statusIcon = "";
                            
                            if (isChecked) {
                                // –ü–û–°–õ–ï –ü–†–û–í–ï–†–ö–ò - —Ü–≤–µ—Ç–æ–≤–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞
                                if (answer.isCorrect) {
                                    answerClass += " answer-correct";
                                    statusIcon = '<span class="answer-status">‚úÖ</span>';
                                } else if (userAnswer === index && !answer.isCorrect) {
                                    answerClass += " answer-incorrect";
                                    statusIcon = '<span class="answer-status">‚ùå</span>';
                                } else {
                                    answerClass += " answer-neutral";
                                }
                            } else {
                                // –î–û –ü–†–û–í–ï–†–ö–ò - –æ–±—ã—á–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                                if (userAnswer === index) {
                                    answerClass += " selected";
                                }
                            }
                            
                            return `
                                <div class="${answerClass}" onclick="selectAnswer(${index})">
                                    <span class="answer-letter">${String.fromCharCode(65 + index)}</span>
                                    <span class="answer-text">${answer.text}</span>
                                    ${statusIcon}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        // ===== –í–´–ë–û–† –û–¢–í–ï–¢–ê =====
        function selectAnswer(answerIndex) {
            if (checkedQuestions.has(currentQuestionIndex)) {
                return;
            }
            
            userAnswers[currentQuestionIndex] = answerIndex;
            displayCurrentQuestion();
            document.getElementById('answer-feedback').innerHTML = '';
        }

        // ===== –ü–†–û–í–ï–†–ö–ê –û–¢–í–ï–¢–ê –¢–û–õ–¨–ö–û –° –¶–í–ï–¢–û–í–û–ô –ü–û–î–°–í–ï–¢–ö–û–ô =====
function checkAnswer() {
    const currentAnswer = userAnswers[currentQuestionIndex];
    
    if (currentAnswer === undefined) {
        return; // –ü—Ä–æ—Å—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω
    }
    
    // –ü–æ–º–µ—á–∞–µ–º –≤–æ–ø—Ä–æ—Å –∫–∞–∫ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π
    checkedQuestions.add(currentQuestionIndex);
    
    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤–æ–ø—Ä–æ—Å —Å —Ü–≤–µ—Ç–æ–≤–æ–π –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π
    displayCurrentQuestion();
}

        // ===== –ù–ê–í–ò–ì–ê–¶–ò–Ø –ü–û –í–û–ü–†–û–°–ê–ú =====
        function nextQuestion() {
            document.getElementById('answer-feedback').innerHTML = '';
            
            if (currentQuestionIndex < currentTest.questions.length - 1) {
                currentQuestionIndex++;
                displayCurrentQuestion();
            } else {
                finishTest();
            }
        }

        function previousQuestion() {
            document.getElementById('answer-feedback').innerHTML = '';
            
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayCurrentQuestion();
            }
        }

        // ===== –ó–ê–í–ï–†–®–ï–ù–ò–ï –¢–ï–°–¢–ê =====
        function finishTest() {
            const timeSpent = Math.round((Date.now() - testStartTime) / 1000);
            const correctAnswers = calculateCorrectAnswers();
            const totalQuestions = currentTest.questions.length;
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            
            const questionContainer = document.getElementById('question-container');
            questionContainer.innerHTML = `
                <div class="result-card">
                    <h2>üéâ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!</h2>
                    <div class="result-stats">
                        <div class="stat">
                            <span class="stat-value">${correctAnswers}/${totalQuestions}</span>
                            <span class="stat-label">–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value">${percentage}%</span>
                            <span class="stat-label">–†–µ–∑—É–ª—å—Ç–∞—Ç</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value">${Math.round(timeSpent / 60)} –º–∏–Ω</span>
                            <span class="stat-label">–í—Ä–µ–º—è</span>
                        </div>
                    </div>
                    <button onclick="showScreen('tests-screen')" class="btn btn-primary">–ö —Å–ø–∏—Å–∫—É —Ç–µ—Å—Ç–æ–≤</button>
                    <button onclick="showScreen('main-screen')" class="btn btn-secondary">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
                </div>
            `;
            
            document.getElementById('test-progress').innerHTML = '';
            document.querySelector('.test-controls').style.display = 'none';
        }

        function calculateCorrectAnswers() {
            let correct = 0;
            currentTest.questions.forEach((question, index) => {
                const userAnswer = userAnswers[index];
                if (userAnswer !== undefined && question.answers[userAnswer].isCorrect) {
                    correct++;
                }
            });
            return correct;
        }
    </script>
</body>
</html>