<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lycoris Tests</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#922B3E">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

</head>

<body>
    <div id="app">
        <!-- –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div id="auth-screen" class="screen active">
        <div class="container">
            <h1>üéØ Lycoris</h1>
            <p>–¢–µ—Å—Ç—ã –∏ –æ–±—É—á–µ–Ω–∏–µ</p>
        
        <div class="auth-form">
            <input type="email" id="email" placeholder="Email" class="input">
            <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" class="input">
            <button onclick="handleAuth()" class="btn btn-primary" id="auth-button">–í–æ–π—Ç–∏</button>
            <button onclick="toggleAuthMode()" class="btn btn-secondary" id="toggle-auth-button">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>
        
            <div id="auth-message" style="margin-top: 15px;"></div>
        </div>
    </div>
        
        <!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω (—Å–∫—Ä—ã—Ç —Å–Ω–∞—á–∞–ª–∞) -->
        <div id="main-screen" class="screen">
            <div class="container">
                <h1>–ì–ª–∞–≤–Ω–∞—è</h1>
                <p id="user-email" style="color: #888; margin-bottom: 20px;"></p>
                <div class="menu">
                    <button onclick="showTests()" class="btn btn-primary">–ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç</button>
                    <button onclick="showStats()" class="btn btn-primary">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
                    <button onclick="logout()" class="btn btn-secondary">–í—ã–π—Ç–∏</button>
                </div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —Å–ø–∏—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤ -->
        <div id="tests-screen" class="screen">
            <div class="container">
                <h1>üìö –¢–µ—Å—Ç—ã</h1>
                <div id="tests-list" class="tests-container">
                    <!-- –¢–µ—Å—Ç—ã –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
                </div>
                <button onclick="showScreen('main-screen')" class="btn btn-secondary">–ù–∞–∑–∞–¥</button>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
<div id="stats-screen" class="screen">
    <div class="container">
        <h1>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h1>
        <div id="stats-content" class="tests-container">
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
        </div>
        <button onclick="showScreen('main-screen')" class="btn btn-secondary">–ù–∞–∑–∞–¥</button>
    </div>
</div>

        <!-- –≠–∫—Ä–∞–Ω –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–∞ -->
        <div id="test-session-screen" class="screen">
            <div class="container">
                <div id="question-container">
                    <!-- –í–æ–ø—Ä–æ—Å –∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã -->
                </div>
                <div class="test-controls">
                    <button onclick="finishTest()" class="btn-small btn-danger">‚èπÔ∏è</button>
                    <button onclick="previousQuestion()" class="btn-small btn-secondary">‚¨ÖÔ∏è</button>
                    <button onclick="checkAnswer()" class="btn-small btn-warning">‚úÖ</button>
                    <button onclick="nextQuestion()" class="btn-small btn-primary">‚û°Ô∏è</button>
                </div>
                <div id="test-progress"></div>
                <div id="answer-feedback"></div>
            </div>
        </div>
    </div>

    <script>
        // ===== FIREBASE CONFIG =====
        const firebaseConfig = {
            apiKey: "AIzaSyCrixbCDYIDnQJy9i-5OqfRBzl-yv6VPCo",
            authDomain: "lotos-vbinc.firebaseapp.com",
            projectId: "lotos-vbinc",
            storageBucket: "lotos-vbinc.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID", // –ó–∞–º–µ–Ω–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π
            appId: "YOUR_APP_ID" // –ó–∞–º–µ–Ω–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // ===== –ë–ê–ó–û–í–ê–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø =====
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }
        
        // ===== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø FIREBASE =====
        let isLoginMode = true;

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            const authButton = document.getElementById('auth-button');
            const toggleButton = document.getElementById('toggle-auth-button');
            const messageDiv = document.getElementById('auth-message');
            
            if (isLoginMode) {
                authButton.textContent = '–í–æ–π—Ç–∏';
                toggleButton.textContent = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è';
                messageDiv.innerHTML = '';
            } else {
                authButton.textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
                toggleButton.textContent = '–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç';
                messageDiv.innerHTML = '<p style="color: #888; font-size: 14px;">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –ø–∞—Ä–æ–ª—è - 6 —Å–∏–º–≤–æ–ª–æ–≤</p>';
            }
        }

        async function handleAuth() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const messageDiv = document.getElementById('auth-message');
            const authButton = document.getElementById('auth-button');
            
            if (!email || !password) {
                showAuthMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }
            
            if (password.length < 6 && !isLoginMode) {
                showAuthMessage('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
                return;
            }
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            authButton.disabled = true;
            authButton.textContent = isLoginMode ? '–í—Ö–æ–¥...' : '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...';
            
            try {
                if (isLoginMode) {
                    await auth.signInWithEmailAndPassword(email, password);
                } else {
                    await auth.createUserWithEmailAndPassword(email, password);
                }
                // –£—Å–ø–µ—à–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–π–¥–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
            } catch (error) {
                let errorMessage = '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏';
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å';
                        break;
                    case 'auth/email-already-in-use':
                        errorMessage = 'Email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è';
                        break;
                    case 'auth/weak-password':
                        errorMessage = '–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º –ø—Ä–æ—Å—Ç–æ–π';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email';
                        break;
                }
                showAuthMessage(errorMessage, 'error');
            } finally {
                authButton.disabled = false;
                authButton.textContent = isLoginMode ? '–í–æ–π—Ç–∏' : '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
            }
        }

        function showAuthMessage(message, type) {
            const messageDiv = document.getElementById('auth-message');
            const color = type === 'error' ? '#ff4444' : '#44ff44';
            messageDiv.innerHTML = `<p style="color: ${color}; text-align: center;">${message}</p>`;
        }

        // ===== –ü–†–û–í–ï–†–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï =====
        auth.onAuthStateChanged((user) => {
            if (user) {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                showScreen('main-screen');
                document.getElementById('user-email').textContent = user.email;
                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:', user.email);
            } else {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                showScreen('auth-screen');
                document.getElementById('user-email').textContent = '';
            }
        });

        // ===== –í–´–•–û–î –ò–ó –°–ò–°–¢–ï–ú–´ =====
        function logout() {
            auth.signOut();
        }

        function showTests() {
            showScreen('tests-screen');
            loadTestsList();
        }
        
        function showStats() {
    const user = auth.currentUser;
    if (!user) return;

    showScreen('stats-screen');
    loadUserStats();
}

async function loadUserStats() {
    const user = auth.currentUser;
    if (!user) return;

    try {
        const database = firebase.database();
        const statsRef = database.ref('users').child(user.uid).child('stats');
        
        statsRef.once('value').then((snapshot) => {
            const stats = snapshot.val();
            displayStats(stats);
        });
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
    }
}

function displayStats(stats) {
    const statsContainer = document.getElementById('stats-content');
    
    if (!stats) {
        statsContainer.innerHTML = '<p>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</p>';
        return;
    }

    const avgPercentage = stats.totalTests > 0 ? Math.round((stats.totalCorrect / (stats.totalCorrect + stats.totalWrong)) * 100) : 0;
    const avgTimePerTest = stats.completedTests > 0 ? Math.round(stats.totalTimeSeconds / stats.completedTests) : 0;

    statsContainer.innerHTML = `
        <div class="stats-overview">
            <div class="stat-card">
                <div class="stat-number">${stats.completedTests || 0}</div>
                <div class="stat-title">–ü—Ä–æ–π–¥–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${stats.activeDays || 0}</div>
                <div class="stat-title">–ê–∫—Ç–∏–≤–Ω—ã—Ö –¥–Ω–µ–π</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${avgPercentage}%</div>
                <div class="stat-title">–°—Ä–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
            </div>
        </div>
        
        <div class="result-section">
            <div class="result-label">üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
            <div class="stats-details">
                <div class="stat-detail">
                    <span>‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤:</span>
                    <span class="stat-detail-value">${stats.totalCorrect || 0}</span>
                </div>
                <div class="stat-detail">
                    <span>‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤:</span>
                    <span class="stat-detail-value">${stats.totalWrong || 0}</span>
                </div>
                <div class="stat-detail">
                    <span>‚è±Ô∏è –û–±—â–µ–µ –≤—Ä–µ–º—è:</span>
                    <span class="stat-detail-value">${stats.totalTimeFormatted || '00:00:00'}</span>
                </div>
                <div class="stat-detail">
                    <span>üìÖ –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –Ω–∞ —Ç–µ—Å—Ç:</span>
                    <span class="stat-detail-value">${formatTimeShort(avgTimePerTest)}</span>
                </div>
            </div>
        </div>
        
        <div class="result-section">
            <div class="result-label">üåÖ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫</div>
            <div class="activity-stats">
                <div class="activity-item">
                    <span>üåÖ –£—Ç—Ä–æ (6-12):</span>
                    <span class="activity-value">${stats.activityMorning || 0} —Ç–µ—Å—Ç–æ–≤</span>
                </div>
                <div class="activity-item">
                    <span>‚òÄÔ∏è –î–µ–Ω—å (13-18):</span>
                    <span class="activity-value">${stats.activityDay || 0} —Ç–µ—Å—Ç–æ–≤</span>
                </div>
                <div class="activity-item">
                    <span>üåô –í–µ—á–µ—Ä (19+):</span>
                    <span class="activity-value">${stats.activityEvening || 0} —Ç–µ—Å—Ç–æ–≤</span>
                </div>
            </div>
        </div>
    `;
}

        // ===== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –¢–ï–°–¢–û–í =====
        let currentTest = null;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let testStartTime = null;
        let checkedQuestions = new Set();

        // ===== –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ò FIREBASE =====
function saveTestResults(correctAnswers, totalQuestions, timeSpentSeconds) {
    const user = auth.currentUser;
    if (!user) return;

    const database = firebase.database();
    const userRef = database.ref('users').child(user.uid);
    const timestamp = Date.now();
    
    // –û—á–∏—Å—Ç–∫–∞ –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–µ—Å—Ç–∞ –æ—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
    const safeTestTitle = currentTest.title.replace(/[.#$\[\]]/g, '_');
    const percentage = Math.round((correctAnswers / totalQuestions) * 100);

    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    const hour = new Date().getHours();
    const activityField = hour >= 6 && hour <= 12 ? "activityMorning" : 
                         hour >= 13 && hour <= 18 ? "activityDay" : "activityEvening";

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Ç–µ—Å—Ç–∞
    const testHistoryData = {
        score: correctAnswers,
        testDurationSeconds: timeSpentSeconds,
        timestamp: timestamp,
        totalQuestions: totalQuestions,
        percentage: percentage,
        testTitle: currentTest.title
    };

    userRef.child('testHistory').child(safeTestTitle).child(timestamp).set(testHistoryData);

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    userRef.child('email').set(user.email);

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    userRef.child('stats').once('value').then((snapshot) => {
        const currentStats = snapshot.val() || {
            completedTests: 0,
            totalCorrect: 0,
            totalWrong: 0,
            totalTests: 0,
            totalTimeSeconds: 0,
            activeDays: 0,
            activityMorning: 0,
            activityDay: 0,
            activityEvening: 0,
            lastCorrect: 0,
            lastWrong: 0,
            lastPercent: 0,
            lastTime: 0
        };

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ —Å–µ–≥–æ–¥–Ω—è —Ç–µ—Å—Ç
        const today = new Date().toDateString();
        userRef.child('lastActivityDate').once('value').then((lastDateSnapshot) => {
            const lastActivityDate = lastDateSnapshot.val();
            let newActiveDays = currentStats.activeDays;
            
            if (lastActivityDate !== today) {
                newActiveDays++;
                userRef.child('lastActivityDate').set(today);
            }

            const updatedStats = {
                completedTests: currentStats.completedTests + 1,
                totalCorrect: currentStats.totalCorrect + correctAnswers,
                totalWrong: currentStats.totalWrong + (totalQuestions - correctAnswers),
                totalTests: currentStats.totalTests + 1,
                totalTimeSeconds: (currentStats.totalTimeSeconds || 0) + timeSpentSeconds,
                totalTimeFormatted: formatTime((currentStats.totalTimeSeconds || 0) + timeSpentSeconds),
                activeDays: newActiveDays,
                activityMorning: activityField === "activityMorning" ? currentStats.activityMorning + 1 : currentStats.activityMorning,
                activityDay: activityField === "activityDay" ? currentStats.activityDay + 1 : currentStats.activityDay,
                activityEvening: activityField === "activityEvening" ? currentStats.activityEvening + 1 : currentStats.activityEvening,
                lastCorrect: correctAnswers,
                lastWrong: totalQuestions - correctAnswers,
                lastPercent: percentage,
                lastTime: timeSpentSeconds,
                timestamp: timestamp
            };

            userRef.child('stats').set(updatedStats);
        });
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ–¥–µ–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    const weekStart = getWeekStartTimestamp();
    userRef.child('weeklyStats').once('value').then((weeklySnapshot) => {
        const currentWeekly = weeklySnapshot.val() || {
            weekStart: weekStart,
            correctAnswers: 0,
            wrongAnswers: 0,
            completedTests: 0,
            totalTime: 0
        };

        const updatedWeekly = {
            weekStart: weekStart,
            correctAnswers: currentWeekly.correctAnswers + correctAnswers,
            wrongAnswers: currentWeekly.wrongAnswers + (totalQuestions - correctAnswers),
            completedTests: currentWeekly.completedTests + 1,
            totalTime: currentWeekly.totalTime + timeSpentSeconds
        };

        userRef.child('weeklyStats').set(updatedWeekly);
    });
}

function getWeekStartTimestamp() {
    const now = new Date();
    const day = now.getDay();
    const diff = now.getDate() - day + (day === 0 ? -6 : 1); // –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –∫–∞–∫ –Ω–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏
    const weekStart = new Date(now.setDate(diff));
    weekStart.setHours(0, 0, 0, 0);
    return weekStart.getTime();
}

function formatTime(totalSeconds) {
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

        // ===== –ó–ê–ì–†–£–ó–ö–ê –°–ü–ò–°–ö–ê –¢–ï–°–¢–û–í =====
        async function loadTestsList() {
            const testsContainer = document.getElementById('tests-list');
            testsContainer.innerHTML = '<p>–ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ—Å—Ç—ã...</p>';

            try {
                const response = await fetch('https://tikaaaani.github.io/Lycoris-umbrella/tests/index.json');
                const data = await response.json();
                
                displayTests(data.tests);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤:', error);
                testsContainer.innerHTML = `
                    <div style="text-align: center; color: #ff4444;">
                        <p>üòî –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ—Å—Ç—ã</p>
                        <p style="font-size: 14px; color: #888;">${error.message}</p>
                        <button onclick="loadTestsList()" class="btn btn-primary" style="margin-top: 15px;">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                    </div>
                `;
            }
        }

        // ===== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –°–ü–ò–°–ö–ê –¢–ï–°–¢–û–í =====
        function displayTests(tests) {
            const testsContainer = document.getElementById('tests-list');
            
            if (tests.length === 0) {
                testsContainer.innerHTML = '<p>–¢–µ—Å—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                return;
            }

            testsContainer.innerHTML = tests.map(test => `
                <div class="test-card" onclick="startTest('${test.id}')">
                    <div class="test-header">
                        <h3>${test.name}</h3>
                        <span class="test-difficulty ${getDifficultyClass(test.difficulty)}">${test.difficulty}</span>
                    </div>
                    <p class="test-description">${test.description}</p>
                    <div class="test-info">
                        <span>üìù ${test.questionCount} –≤–æ–ø—Ä–æ—Å–æ–≤</span>
                        <span>‚è± ${test.estimatedTime}</span>
                        <span class="file-type">${test.fileName.endsWith('.lyc') ? 'üîí' : 'üìÑ'} ${test.fileName.split('.').pop()}</span>
                    </div>
                </div>
            `).join('');
        }

        function getDifficultyClass(difficulty) {
            const difficultyMap = {
                '–õ–µ–≥–∫–∏–π': 'difficulty-easy',
                '–°—Ä–µ–¥–Ω–∏–π': 'difficulty-medium', 
                '–°–ª–æ–∂–Ω—ã–π': 'difficulty-hard',
                'Easy': 'difficulty-easy',
                'Medium': 'difficulty-medium',
                'Hard': 'difficulty-hard'
            };
            return difficultyMap[difficulty] || 'difficulty-medium';
        }

        // ===== –ó–ê–ü–£–°–ö –¢–ï–°–¢–ê =====
        async function startTest(testId) {
            const testsContainer = document.getElementById('tests-list');
    
            try {
                testsContainer.innerHTML = `
                    <div style="text-align: center;">
                        <div class="loading-spinner"></div>
                        <p>–ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ—Å—Ç...</p>
                    </div>
                `;

                // –í–û–°–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –í–ò–î–ò–ú–û–°–¢–¨ –ö–ù–û–ü–û–ö –£–ü–†–ê–í–õ–ï–ù–ò–Ø
                const testControls = document.querySelector('.test-controls');
                if (testControls) {
                    testControls.style.display = 'flex';
                }

                const testData = await loadRealTestData(testId);
            
                if (!testData || !testData.questions || testData.questions.length === 0) {
                    throw new Error('–¢–µ—Å—Ç –ø—É—Å—Ç–æ–π –∏–ª–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω');
                }

                currentTest = testData;
                currentQuestionIndex = 0;
                userAnswers = [];
                checkedQuestions = new Set();
                testStartTime = Date.now();
            
                showScreen('test-session-screen');
                displayCurrentQuestion();
            
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–∞:', error);
                testsContainer.innerHTML = `
                    <div class="error-message">
                        <p>‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ—Å—Ç</p>
                        <p style="font-size: 14px; margin-top: 8px;">${error.message}</p>
                        <button onclick="loadTestsList()" class="btn btn-primary" style="margin-top: 15px;">
                            –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É
                        </button>
                    </div>
                `;
            }
        }

        // ===== –†–ï–ê–õ–¨–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê –¢–ï–°–¢–û–í =====
        async function loadRealTestData(testId) {
            try {
                console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ—Å—Ç ID:', testId);
                
                const testsResponse = await fetch('https://tikaaaani.github.io/Lycoris-umbrella/tests/index.json');
                const testsData = await testsResponse.json();
                
                const testInfo = testsData.tests.find(test => test.id === testId);
                if (!testInfo) {
                    throw new Error('–¢–µ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ index.json');
                }

                console.log('–ù–∞–π–¥–µ–Ω —Ç–µ—Å—Ç:', testInfo);

                let testContent;
                
                try {
                    console.log('–ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å JSON:', testInfo.fileName);
                    const jsonResponse = await fetch(`https://tikaaaani.github.io/Lycoris-umbrella/tests/${testInfo.fileName}`);
                    
                    if (!jsonResponse.ok) {
                        throw new Error(`HTTP error! status: ${jsonResponse.status}`);
                    }
                    
                    testContent = await jsonResponse.text();
                    console.log('JSON –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ');
                    
                } catch (jsonError) {
                    console.log('JSON –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–±—É–µ–º LYC...', jsonError);
                    
                    const lycFileName = testInfo.fileName.replace('.json', '.lyc');
                    const lycResponse = await fetch(`https://tikaaaani.github.io/Lycoris-umbrella/tests/${lycFileName}`);
                    
                    if (!lycResponse.ok) {
                        throw new Error(`LYC —Ñ–∞–π–ª —Ç–æ–∂–µ –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω: ${lycResponse.status}`);
                    }
                    
                    const encryptedData = await lycResponse.arrayBuffer();
                    testContent = await decryptTestContent(new Uint8Array(encryptedData));
                    console.log('LYC —Ñ–∞–π–ª —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω');
                }

                const testData = JSON.parse(testContent);
                console.log('–¢–µ—Å—Ç —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω, –≤–æ–ø—Ä–æ—Å–æ–≤:', testData.questions.length);
                
                return {
                    id: testId,
                    title: testInfo.name,
                    questions: testData.questions
                };
                
            } catch (error) {
                console.error('–ü–æ–ª–Ω–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ—Å—Ç–∞:', error);
                throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ—Å—Ç: ' + error.message);
            }
        }

        // ===== –î–ï–®–ò–§–†–û–í–ê–ù–ò–ï .lyc –§–ê–ô–õ–û–í =====
        async function decryptTestContent(encryptedContent) {
            try {
                try {
                    const text = new TextDecoder().decode(encryptedContent);
                    const decoded = atob(text);
                    console.log('–ü—Ä—è–º–æ–µ Base64 –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ');
                    return decoded;
                } catch (simpleError) {
                    console.log('–ü—Ä—è–º–æ–µ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ, –ø—Ä–æ–±—É–µ–º AES...');
                    
                    const key = "YouWillFindYourLoveDear";
                    const keyBytes = normalizeKey(key);
                    
                    const cryptoKey = await crypto.subtle.importKey(
                        'raw',
                        keyBytes,
                        { name: 'AES-CBC' },
                        false,
                        ['decrypt']
                    );

                    const text = new TextDecoder().decode(encryptedContent);
                    const decodedBytes = Uint8Array.from(atob(text), c => c.charCodeAt(0));
                    
                    const iv = decodedBytes.slice(0, 16);
                    const data = decodedBytes.slice(16);
                    
                    const decrypted = await crypto.subtle.decrypt(
                        {
                            name: 'AES-CBC',
                            iv: iv
                        },
                        cryptoKey,
                        data
                    );
                    
                    return new TextDecoder().decode(decrypted);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è:', error);
                throw new Error('–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Ç–µ—Å—Ç–∞: ' + error.message);
            }
        }

        function normalizeKey(key) {
            const keyBytes = new TextEncoder().encode(key);
            const requiredLength = 16;
            
            if (keyBytes.length === requiredLength) {
                return keyBytes;
            }
            
            const normalizedKey = new Uint8Array(requiredLength);
            normalizedKey.set(keyBytes.slice(0, Math.min(keyBytes.length, requiredLength)));
            return normalizedKey;
        }

        // ===== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –í–û–ü–†–û–°–ê –° –¶–í–ï–¢–û–í–û–ô –ü–û–î–°–í–ï–¢–ö–û–ô =====
        function displayCurrentQuestion() {
            const questionContainer = document.getElementById('question-container');
            const progressContainer = document.getElementById('test-progress');
            
            if (!currentTest || !currentTest.questions[currentQuestionIndex]) {
                finishTest();
                return;
            }

            const question = currentTest.questions[currentQuestionIndex];
            const progress = ((currentQuestionIndex + 1) / currentTest.questions.length * 100).toFixed(0);
            const isChecked = checkedQuestions.has(currentQuestionIndex);
            const userAnswer = userAnswers[currentQuestionIndex];
            
            // –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä
            progressContainer.innerHTML = `
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%"></div>
                </div>
                <div class="progress-text">${currentQuestionIndex + 1} / ${currentTest.questions.length}</div>
            `;

            // –í–æ–ø—Ä–æ—Å –∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ —Å —Ü–≤–µ—Ç–æ–≤–æ–π –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π
            questionContainer.innerHTML = `
                <div class="question-card">
                    <h2>${question.question}</h2>
                    <div class="answers-list">
                        ${question.answers.map((answer, index) => {
                            let answerClass = "answer-option";
                            let statusIcon = "";
                            
                            if (isChecked) {
                                // –ü–û–°–õ–ï –ü–†–û–í–ï–†–ö–ò - —Ü–≤–µ—Ç–æ–≤–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞
                                if (answer.isCorrect) {
                                    answerClass += " answer-correct";
                                    statusIcon = '<span class="answer-status">‚úÖ</span>';
                                } else if (userAnswer === index && !answer.isCorrect) {
                                    answerClass += " answer-incorrect";
                                    statusIcon = '<span class="answer-status">‚ùå</span>';
                                } else {
                                    answerClass += " answer-neutral";
                                }
                            } else {
                                // –î–û –ü–†–û–í–ï–†–ö–ò - –æ–±—ã—á–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                                if (userAnswer === index) {
                                    answerClass += " selected";
                                }
                            }
                            
                            return `
                                <div class="${answerClass}" onclick="selectAnswer(${index})">
                                    <span class="answer-text">${answer.text}</span>
                                    ${statusIcon}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        // ===== –í–´–ë–û–† –û–¢–í–ï–¢–ê =====
        function selectAnswer(answerIndex) {
            if (checkedQuestions.has(currentQuestionIndex)) {
                return;
            }
            
            userAnswers[currentQuestionIndex] = answerIndex;
            displayCurrentQuestion();
            document.getElementById('answer-feedback').innerHTML = '';
        }

        // ===== –ü–†–û–í–ï–†–ö–ê –û–¢–í–ï–¢–ê –¢–û–õ–¨–ö–û –° –¶–í–ï–¢–û–í–û–ô –ü–û–î–°–í–ï–¢–ö–û–ô =====
        function checkAnswer() {
            const currentAnswer = userAnswers[currentQuestionIndex];
            
            if (currentAnswer === undefined) {
                return; // –ü—Ä–æ—Å—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω
            }
            
            // –ü–æ–º–µ—á–∞–µ–º –≤–æ–ø—Ä–æ—Å –∫–∞–∫ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π
            checkedQuestions.add(currentQuestionIndex);
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤–æ–ø—Ä–æ—Å —Å —Ü–≤–µ—Ç–æ–≤–æ–π –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π
            displayCurrentQuestion();
        }

        // ===== –ù–ê–í–ò–ì–ê–¶–ò–Ø –ü–û –í–û–ü–†–û–°–ê–ú =====
        function nextQuestion() {
            document.getElementById('answer-feedback').innerHTML = '';
            
            if (currentQuestionIndex < currentTest.questions.length - 1) {
                currentQuestionIndex++;
                displayCurrentQuestion();
            } else {
                finishTest();
            }
        }

        function previousQuestion() {
            document.getElementById('answer-feedback').innerHTML = '';
            
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayCurrentQuestion();
            }
        }

        // ===== –ó–ê–í–ï–†–®–ï–ù–ò–ï –¢–ï–°–¢–ê =====
        // ===== –ó–ê–í–ï–†–®–ï–ù–ò–ï –¢–ï–°–¢–ê –° –ö–†–ê–°–ò–í–´–ú –†–ï–ó–£–õ–¨–¢–ê–¢–û–ú =====
function finishTest() {
    const timeSpentSeconds = Math.round((Date.now() - testStartTime) / 1000);
    const correctAnswers = calculateCorrectAnswers();
    const totalQuestions = currentTest.questions.length;
    const percentage = Math.round((correctAnswers / totalQuestions) * 100);
    const incorrectAnswers = totalQuestions - correctAnswers;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ Firebase
    saveTestResults(correctAnswers, totalQuestions, timeSpentSeconds);
    
    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ—Ä–∞–∑—ã –ø–æ –ø—Ä–æ—Ü–µ–Ω—Ç—É
    const { phrase, emoji, color } = getResultPhrase(percentage);
    
    const questionContainer = document.getElementById('question-container');
    questionContainer.innerHTML = `
        <div class="result-card">
            <h2>üéâ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!</h2>
            
            <!-- –í—Ä–µ–º—è -->
            <div class="result-section">
                <div class="result-label">‚è±Ô∏è –ó–∞—Ç—Ä–∞—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è</div>
                <div class="result-value-large">${formatTimeShort(timeSpentSeconds)}</div>
            </div>
            
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ -->
            <div class="result-section">
                <div class="result-label">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤</div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-emoji">‚úÖ</div>
                        <div class="stat-value" style="color: #00C853;">${correctAnswers}</div>
                        <div class="stat-label">–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-emoji">‚ùå</div>
                        <div class="stat-value" style="color: #D50000;">${incorrectAnswers}</div>
                        <div class="stat-label">–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-emoji">üìù</div>
                        <div class="stat-value" style="color: #757575;">${totalQuestions}</div>
                        <div class="stat-label">–í—Å–µ–≥–æ</div>
                    </div>
                </div>
            </div>
            
            <!-- –ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ -->
            <div class="result-section">
                <div class="result-label">üìà –ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤</div>
                <div class="result-value-large" style="color: ${color};">${percentage}%</div>
                <div class="progress-bar" style="margin: 15px 0;">
                    <div class="progress-fill" style="width: ${percentage}%; background: ${color};"></div>
                </div>
            </div>
            
            <!-- –§—Ä–∞–∑–∞ —Å —ç–º–æ–¥–∑–∏ -->
            <div class="phrase-card" style="background: ${color}20; border-color: ${color};">
                <div class="phrase-text">${phrase}</div>
                <div class="phrase-emoji">${emoji}</div>
            </div>
            
            <div class="result-buttons">
                <button onclick="showScreen('tests-screen')" class="btn btn-primary">–ö —Å–ø–∏—Å–∫—É —Ç–µ—Å—Ç–æ–≤</button>
                <button onclick="showScreen('main-screen')" class="btn btn-secondary">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
            </div>
        </div>
    `;
    
    document.getElementById('test-progress').innerHTML = '';
    document.querySelector('.test-controls').style.display = 'none';
}

function getResultPhrase(percentage) {
    if (percentage >= 90) {
        return { 
            phrase: "–°–µ–∫—Å-–∫–∞–±–∏–Ω–µ—Ç –≤ —Ç—Ä–∞—Ö–µ –æ—Ç —Ç–∞–∫–∏—Ö –∫–∞–∫ —Ç—ã!", 
            emoji: "üòòü¶àüê¶‚Äçüî•", 
            color: "#00C853" 
        };
    } else if (percentage >= 76) {
        return { 
            phrase: "–¢–≤–µ—Ä–¥–∞—è —á–µ—Ç–≤—ë—Ä–æ—á–∫–∞, –Ω–∞–¥–æ –ø–æ–¥–Ω–∞—Ç—É–∂–∏—Ç—Ü–∞!", 
            emoji: "‚ù§Ô∏èü•∫", 
            color: "#64DD17" 
        };
    } else if (percentage >= 66) {
        return { 
            phrase: "–£–∂–µ —É—Ä–æ–≤–µ–Ω—å –≤–µ–∑–µ–Ω–∏—è", 
            emoji: "ü§û", 
            color: "#FFD600" 
        };
    } else if (percentage >= 61) {
        return { 
            phrase: "–ù–∞ —Ç–æ–Ω–µ–Ω—å–∫–æ–≥–æ! –ò–¥–∏ –ø–æ–≤—Ç–æ—Ä—è–π", 
            emoji: "‚úåÔ∏èüò∂‚Äçüå´Ô∏è", 
            color: "#FF9800" 
        };
    } else {
        return { 
            phrase: "–ü–æ–∑–æ—Ä–∏—â–µ –∏–¥–∏ —É—á–∏", 
            emoji: "ü§¢ü§Æ", 
            color: "#D50000" 
        };
    }
}

function formatTimeShort(totalSeconds) {
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

        function calculateCorrectAnswers() {
            let correct = 0;
            currentTest.questions.forEach((question, index) => {
                const userAnswer = userAnswers[index];
                if (userAnswer !== undefined && question.answers[userAnswer].isCorrect) {
                    correct++;
                }
            });
            return correct;
        }
    </script>
</body>
</html>